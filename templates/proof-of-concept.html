<!DOCTYPE html>
<meta charset="utf-8">
<style>

  html, body {
    height: 100%;
    min-height: 100%;
  }

  .dropdown-menu {
    width: 100%;
  }

</style>
<title>Denver Crime Map Proof-of-concept</title>
<head>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>  <meta charset="utf-8">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="http://bootswatch.com/darkly/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src={{url_for('static', filename='heatmap.js')}}></script>
  <script src={{url_for('static', filename='leaflet-heatmap.js')}}></script>
  <title>Denver Crime Map</title>
</head>


<body class="container-fluid">
<h3 class="well well-md">Denver Crime Map
  <br><small>Identifying trends in crimes committed in Denver in the month of March 2015</small></h3>
<div id="controls" class="row-fluid">
  <div class="col-md-12">
    <div class="dropdown">
      <button type="button" class="btn btn-default btn-block" data-toggle="dropdown">
        Select crime category <span class="caret"></span></button>
      <ul class="dropdown-menu" id="crime">
        <!-- menu items generated by d3 -->
      </ul>
    <button type="button" id="start" class="btn btn-success btn-block"
            onclick="animate_map();">Run visualization</button>
    </div>
  </div>
</div>
<div id="map-row" class="row-fluid">
  <div class="col-md-12">
    <div id="map" class=""></div>
    <p class="text-muted" id="date_display"></p>
  </div>
</div>


<script type="text/javascript">

  // define local data location
  var fname = 'crime_cats_201503';
  var data_fpath = '/static/' + fname + '.topojson';

  var n = 14;  // max datum val/num intervals visible (?)
  var speed = 100;

  // declare global vars (for debug)
  var full_data = [];
  var features;
  var crimes;
  var crime_selected;
  var intervals;  // need global access to cancel

  ///////////// heatmap.js /////////////
  var config = {
    "radius": 15,
    "maxOpacity": 0.9,
    "minOpacity": 0,
    "scaleRadius": false,
    "useLocalExtrema": false,
    "blur": 0.75,
//    gradient: {
//      '0.05': '#ffffcc',
//      '0.25': '#a1dab4',
//      '0.5': '#41b6c4',
//      '0.75': '#2c7fb8',
//      '0.95': '#253494'
//    },
    latField: 'lat',
    lngField: 'lng',
    valueField: 'val'
  };

  // initialize heatmap overlay
  var heatmap = new HeatmapOverlay(config);

  var heatmap_data = {
    max: 4 * n,  // what's an appropriate scaling factor for max?
    min: 0,
    data: []
  };

  ///////////// leaflet.js ////////////
  function map_height () {
    return $(window).height()
        - $("#map-row").offset().top
        - $(document).scrollTop();
  }

  function resize(){
    $('#map').css("height", map_height());
  }

  $('#map').css("height", map_height());

  $(window).on("resize", resize);
  resize();

  var base = new L.TileLayer(
      "http://{s}.tiles.mapbox.com/v4/circld.b689c053/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2lyY2xkIiwiYSI6IjE5MjJCN2MifQ.Ztr1z4FvXHYHFQCxEubPpw"
  );

  var map = L.map('map', {
    center: new L.LatLng(39.737, -104.981),
    zoomControl: false,
    minZoom: 12,
    maxZoom: 13,
    zoom: 13,
    layers: [base, heatmap]
  });

  //////////// animation ////////////
  // add capitalize string method
  String.prototype.capitalize = function() {
    // replace hyphens and cap first letter in each word
    return this.replace(/-/g, ' ')
        .replace(/\b\w/g, function (m) {
          return m.toUpperCase();
        });
  };

  // helper function to push features data into full_data
  function get_coords(element, index, array) {

    var el_type = element.properties.OFFENSE_CATEGORY_ID;

    if (crime_selected === 'all' || crime_selected === el_type) {
      full_data.push({
        datetime: new Date(element.properties.FIRST_OCCURRENCE_DATE),
        crime: el_type,
        shown: false,

        // required heatmap.js vars
        lat: element.geometry.coordinates[1],
        lng: element.geometry.coordinates[0],
        val: 0
      });
    }
  }

  // reset for next animation
  function reset() {
    clearInterval(intervals);
    toggle_run();

    d3.select("#date_display")
        .text(" ");
    heatmap_data.data = [];
// this next line breaks it-- not only are points visible, but no longer tied to map
//    heatmap.setData(heatmap_data);
    full_data = [];
    return true;
  }

  // toggle run viz button
  function toggle_run() {

    if (!(crime_selected)) {
      return false;
    }

    var button = d3.select("#start");
    if (button.text() === 'Run visualization') {
      button.text("Stop visualization")
          .attr({
            onclick: "reset();",
            class: "btn btn-danger btn-block"
          });
    } else {
      button.text("Run visualization")
          .attr({
            onclick: "animate_map();",
            class: "btn btn-success btn-block"
          });
    }
  }

  // run heatmap animation
  function animate_map() {

    if (!(crime_selected)) {
      return false;
    }

    toggle_run();

    // populate heatmap_data arrays
    features.forEach(get_coords);

    // determine date range
    var datetime_extent = d3.extent(full_data, function(d) {
      return d.datetime;
    });
////// add alert if no data points

    // must create new date or will overwrite datetime for datum
    var curr_time = new Date(datetime_extent[0]);
    var last_time = new Date(datetime_extent[1]);

    // normalize
    curr_time.setMinutes(0);
    last_time.setMinutes(0);
    last_time.setHours(last_time.getHours() + 12);
    last_time.setDate(last_time.getDate() + 7);

    function add_next_data() {

      // change curr_time
      if (curr_time.getHours() < 12) {
        curr_time.setHours(12);
      } else {
        curr_time.setDate(curr_time.getDate() + 1);
        curr_time.setHours(0);
      }

      // update current data slice in heatmap_data.data
      heatmap_data.data.forEach(function (element, array, index) {
        if (element.shown && element.val === 0) {
          heatmap_data.data.splice(index, 1);
        }
        if (element.val > 0) {
          element.val -= 1;
        }
      });

      // push qualifying points from full_data into heatmap_data.data
      // note: will need to reset shown & val if reusing full_data
      full_data.forEach( function(element, array, index) {
        if (!element.shown && element.datetime < curr_time) {
          element.shown = true;
          element.val = n;
          heatmap_data.data.push(element);
        }
      });

      // display curr_time in DOM object
      d3.select("#date_display")
          .text(curr_time);

      // update map data points
      heatmap.setData(heatmap_data);

      // reset once current_time > last_time
      if (curr_time > last_time) {
        clearInterval(intervals);
        return reset();
      }
    }

    // call add_next_data for each speed interval
    intervals = setInterval(add_next_data, speed);
  }

  //////////// Reading data & dynamic DOM generation/manipulation ///////////
  d3.json(data_fpath, function(error, data) {

    if (error) return console.error(error);

    // store data in global var
    features = topojson.feature(data, data.objects[fname]).features;

    // crime types
    crimes = d3.set();
    features.forEach(
        function(el, ar, idx) {
          crimes.add(el.properties.OFFENSE_CATEGORY_ID);
        }
    );
    crimes = crimes.values().sort();
    crimes.unshift('all');

    // create crime type dropdown items
    d3.select("#crime")
        .selectAll("li")
        .data(crimes)
        .enter()
        .append("li")
        .append("a")
        .attr("href", "#")
        .text(function(d) { return d.capitalize(); })
        // add event listeners for items
        .on("click", function(d, i) {
          crime_selected = crimes[i];
        });

  });

</script>
